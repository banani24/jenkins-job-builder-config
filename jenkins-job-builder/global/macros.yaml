
- builder:
    name: anchorchain-file
    # Variables: anchorchain-links
    builders:
      - shell:
          !include-raw:
            - ./scripts/anchor-chain.sh

# DSL Builder does not work for targets. Use raw until this is fixed
#- builder:
#    name: dsl-target
#    builders:
#      - dsl:
#          target: {dsl-target}
#          ignore-existing: "false"
#          removed-job-action: "DISABLE"
#          removed-view-action: "DELETE"
#          lookup-strategy: "SEED_JOB"
- builder:
    name: dsl-target
    # Variables: dsl-target
    builders:
      - raw:
          xml: |
            <javaposse.jobdsl.plugin.ExecuteDslScripts plugin="job-dsl@1.35">
              <targets>{dsl-target}</targets>
              <usingScriptText>false</usingScriptText>
              <ignoreExisting>false</ignoreExisting>
              <removedJobAction>DISABLE</removedJobAction>
              <removedViewAction>DELETE</removedViewAction>
              <lookupStrategy>SEED_JOB</lookupStrategy>
              <additionalClasspath></additionalClasspath>
            </javaposse.jobdsl.plugin.ExecuteDslScripts>

- builder:
    name: job-description
    builders:
      - shell:
          !include-raw:
            - ./scripts/description.sh

- builder:
    name: puppet-module-job-description
    builders:
      - shell:
          !include-raw:
            - ./scripts/puppet-module-description.sh

- builder:
    name: puppet-module-param-downstream
    builders:
      - shell:
          !include-raw:
            - ./scripts/puppet-module-param-downstream.sh

- builder:
    name: remote-jjb-definition
    builders:
      - conditional-step:
          condition-kind: files-match
          include-pattern:
              -  "ci_data/jjb/*.yaml"
          condition-basedir: workspace
          steps:
            - trigger-builds:
              - project:
                  - "Jenkins_Job_Builder"
                current-parameters: false
                predefined-parameters:
                  remote_job_name=$JOB_NAME
                block: false

- property:
    name: custom-icon
    # Variables: custom-icon
    properties:
      - raw:
          xml: |
            <jenkins.plugins.jobicon.CustomIconProperty plugin="custom-job-icon@0.2">
              <iconfile>{custom-icon}</iconfile>
            </jenkins.plugins.jobicon.CustomIconProperty>

- publisher:
    name: anchorchain
    # Variables: anchorchain-file
    publishers:
      - raw:
          xml: |
            <ru.snowleos.jenkins.anchorchain.LinksPublisher plugin="AnchorChain@1.0">
              <name>{anchorchain-file}</name>
            </ru.snowleos.jenkins.anchorchain.LinksPublisher>

#- publisher:
#    name: email-general
#    # Variables: 
#    publishers:
#      # May use templates because this isn't as flexible as the actual plugin
#      - email-ext:
#          # for pulling from a file
#          recipients: ${PROPFILE,file="ci_data/email.properties",property="always"}
#          subject: $PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!
#          body: |
#            $PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS:
#             
#            Check console output at $BUILD_URL to view the results.
#          always: false
#          aborted: true
#          failure: true
#          first-failure: true
#          fixed: true
#          improvement: true
#          not-built: true
#          regression: true
#          second-failure: true
#          still-failing: true
#          still-unstable: true
#          success: false
#          unstable: true
#          send-to:
#            - developers
#            - culprits
#      # Build raw macro to do what is desired
#      - raw:
#          xml: |
#            <hudson.plugins.emailext.ExtendedEmailPublisher plugin="email-ext@2.40.5">
#            <recipientList>$DEFAULT_RECIPIENTS</recipientList>
#            <configuredTriggers>
#              <hudson.plugins.emailext.plugins.trigger.FailureTrigger>
#                <email>
#                  <recipientList></recipientList>
#                  <subject>$PROJECT_DEFAULT_SUBJECT</subject>
#                  <body>$PROJECT_DEFAULT_CONTENT</body>
#                  <recipientProviders>
#                    <hudson.plugins.emailext.plugins.recipients.DevelopersRecipientProvider/>
#                    <hudson.plugins.emailext.plugins.recipients.CulpritsRecipientProvider/>
#                  </recipientProviders>
#                  <attachmentsPattern></attachmentsPattern>
#                  <attachBuildLog>false</attachBuildLog>
#                  <compressBuildLog>false</compressBuildLog>
#                  <replyTo>$PROJECT_DEFAULT_REPLYTO</replyTo>
#                  <contentType>project</contentType>
#                </email>
#              </hudson.plugins.emailext.plugins.trigger.FailureTrigger>
#              <hudson.plugins.emailext.plugins.trigger.AlwaysTrigger>
#                <email>
#                  <recipientList>${PROPFILE,file=&quot;email.props&quot;,property=&quot;always&quot;}</recipientList>
#                  <subject>$PROJECT_DEFAULT_SUBJECT</subject>
#                  <body>$PROJECT_DEFAULT_CONTENT</body>
#                  <recipientProviders>
#                    <hudson.plugins.emailext.plugins.recipients.ListRecipientProvider/>
#                  </recipientProviders>
#                  <attachmentsPattern></attachmentsPattern>
#                  <attachBuildLog>false</attachBuildLog>
#                  <compressBuildLog>false</compressBuildLog>
#                  <replyTo>$PROJECT_DEFAULT_REPLYTO</replyTo>
#                  <contentType>project</contentType>
#                </email>
#              </hudson.plugins.emailext.plugins.trigger.AlwaysTrigger>
#            </configuredTriggers>
#            <contentType>default</contentType>
#            <defaultSubject>$DEFAULT_SUBJECT</defaultSubject>
#            <defaultContent>$DEFAULT_CONTENT</defaultContent>
#            <attachmentsPattern></attachmentsPattern>
#            <presendScript>$DEFAULT_PRESEND_SCRIPT</presendScript>
#            <attachBuildLog>false</attachBuildLog>
#            <compressBuildLog>false</compressBuildLog>
#            <replyTo>$DEFAULT_REPLYTO</replyTo>
#            <saveOutput>false</saveOutput>
#            <disabled>false</disabled>
#          </hudson.plugins.emailext.ExtendedEmailPublisher>


- publisher:
    name: email-template
    # Variables: email-template
    publishers:
      - raw:
          xml: |
            <org.jenkinsci.plugins.emailext__template.ExtendedEmailTemplatePublisher plugin="emailext-template@0.4">
              <templateIds>
                <org.jenkinsci.plugins.emailext__template.TemplateId>
                  <templateId>{email-template}</templateId>
                </org.jenkinsci.plugins.emailext__template.TemplateId>
              </templateIds>
            </org.jenkinsci.plugins.emailext__template.ExtendedEmailTemplatePublisher>

#hipchat:
#  enabled: true
#  rooms: {hipchat-room-id}
#  notify-start: true
#  notify-success: true
#  notify-aborted: true
#  notify-not-built: true
#  notify-unstable: true
#  notify-failure: true
#  notify-back-to-normal: true

- publisher:
    name: hipchat
    # Variables: hipchat-token, hipchat-room-id
    publishers:
      - raw:
          xml: |
            <jenkins.plugins.hipchat.HipChatNotifier plugin="hipchat@0.1.9">
              <token>{hipchat-token}</token>
              <room>{hipchat-room-id}</room>
              <startNotification>true</startNotification>
              <notifySuccess>true</notifySuccess>
              <notifyAborted>true</notifyAborted>
              <notifyNotBuilt>true</notifyNotBuilt>
              <notifyUnstable>true</notifyUnstable>
              <notifyFailure>true</notifyFailure>
              <notifyBackToNormal>true</notifyBackToNormal>
              <startJobMessage>$JOB_NAME #$BUILD_NUMBER $STATUS ($CHANGES_OR_CAUSE) (&lt;a href=&quot;$URL&quot;&gt;Open&lt;/a&gt;)</startJobMessage>
              <completeJobMessage>$JOB_NAME #$BUILD_NUMBER $STATUS after $DURATION (&lt;a href=&quot;$URL&quot;&gt;Open&lt;/a&gt;)</completeJobMessage>
            </jenkins.plugins.hipchat.HipChatNotifier>

# Getting errors with this, so using raw for now
#      - trigger-parameterized-builds:
#          project: test
#          condition: STABLE
#          property-file: parameters.txt
- publisher:
    name: param-build-trigger-{project}
    # TODO: define lots of option - maybe many macros until plugin
    publishers:
      - raw:
          xml: |
            <hudson.plugins.parameterizedtrigger.BuildTrigger plugin="parameterized-trigger@2.27">
              <configs>
                <hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
                  <configs class="empty-list"/>
                  <projects>{project}</projects>
                  <condition>SUCCESS</condition>
                  <triggerWithNoParameters>false</triggerWithNoParameters>
                </hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
              </configs>
            </hudson.plugins.parameterizedtrigger.BuildTrigger>

- publisher:
    name: pragmatic-programmer-tips
    publishers:
      - raw:
          xml: |
            <jenkins.plugins.pragprog.PragprogBuildStep plugin="pragprog@1.0.4">
              <displayLanguageCode>en</displayLanguageCode>
              <indicateBuildResult>true</indicateBuildResult>
            </jenkins.plugins.pragprog.PragprogBuildStep>

- publisher:
    name: publishers-from
    # Variables: project
    publishers:
      - raw:
          xml: |
            <hudson.plugins.templateproject.ProxyPublisher plugin="template-project@1.4.2">
              <projectName>{project}</projectName>
            </hudson.plugins.templateproject.ProxyPublisher>

- scm:
    name: github
    # Variables: github-url, github-org, github-repo
    scm:
      - git:
          url: '{github-url}/{github-org}/{github-repo}.git'
          branches:
            - origin/master
          refspec: '+refs/heads/master:refs/remotes/origin/master'
          browser: githubweb
          browser-url: '{github-url}/{github-org}/{github-repo}'
          wipe-workspace: false
          skip-tag: true

- trigger:
    name: files-found-folder
    # Variables: cron, path, include
    triggers:
      - raw:
          xml: |
            <org.jenkinsci.plugins.fstrigger.triggers.FolderContentTrigger plugin="fstrigger@0.39">
              <spec>{cron}</spec>
              <path>{path}</path>
              <includes>{include}</includes>
              <excludeCheckLastModificationDate>false</excludeCheckLastModificationDate>
              <excludeCheckContent>false</excludeCheckContent>
              <excludeCheckFewerOrMoreFiles>false</excludeCheckFewerOrMoreFiles>
            </org.jenkinsci.plugins.fstrigger.triggers.FolderContentTrigger>

- wrapper:
    name: project-desc
    # Variables: desc-file
    wrappers:
      - raw:
          xml: |
            <org.jenkinsCi.plugins.projectDescriptionSetter.DescriptionSetterWrapper plugin="project-description-setter@1.1">
              <charset>UTF-8</charset>
              <projectDescriptionFilename>{desc-file}</projectDescriptionFilename>
              <disableTokens>false</disableTokens>
            </org.jenkinsCi.plugins.projectDescriptionSetter.DescriptionSetterWrapper>

- wrapper:
    name: pyenv
    # Variables: python_version,
    # Possible variables: pyenv_root, pip_list, git_branch, ignore_local, git_repo 
    # TODO:
    #   change $HOME to $JENKINS_HOME
    wrappers:
      - raw:
          xml: |
            <ruby-proxy-object>
              <ruby-object ruby-class="Jenkins::Tasks::BuildWrapperProxy" pluginid="pyenv">
                <pluginid pluginid="pyenv" ruby-class="String">pyenv</pluginid>
                <object ruby-class="PyenvWrapper" pluginid="pyenv">
                  <pyenv__root pluginid="pyenv" ruby-class="String">$HOME/.pyenv</pyenv__root>
                  <pip__list pluginid="pyenv" ruby-class="String">tox</pip__list>
                  <pyenv__revision pluginid="pyenv" ruby-class="String">master</pyenv__revision>
                  <version pluginid="pyenv" ruby-class="String">{python_version}</version>
                  <ignore__local__version ruby-class="TrueClass" pluginid="pyenv"/>
                  <pyenv__repository pluginid="pyenv" ruby-class="String">https://github.com/yyuu/pyenv.git</pyenv__repository>
                </object>
              </ruby-object>
            </ruby-proxy-object>

